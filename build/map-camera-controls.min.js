!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.MapControls=t()}(this,function(){"use strict";var e=window.THREE||require("three"),t=t=function(t,o,n){var i=3.141592653589793,a=i/2,r=this,s={NONE:-1,ROTATE:0,ZOOM:1,PAN:2};this.object=t,this.domElement=void 0!==o?o:document,this.mapRadius=void 0!==n?n.radius:6371,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1,this.panSpeed=1,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.dynamicDampingFactor=.2,this.coord=new e.Vector2(0,a),this.zoom=10,this.pitch=0,this.bearing=0,this.coordEnd=new e.Vector2(0,a),this.zoomEnd=10,this.pitchEnd=0,this.bearingEnd=0,this.minZoom=1,this.maxZoom=18,this.maxPitch=80;var d=s.NONE,c=new e.Vector2,m=new e.Vector2,h={type:"start"},p={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}};var l,u=(l=new e.Vector2,function(e,t){return l.set((e-r.screen.left)/r.screen.width,(t-r.screen.top)/r.screen.height),l}),E=function(t){var o=Math.pow(2,r.zoom-1)*r.rotateSpeed*1e-4;return t.clone().rotateAround(new e.Vector2(0,0),-r.bearing).multiplyScalar(o)};function v(e){!1!==r.enabled&&(e.preventDefault(),e.stopPropagation(),d===s.NONE&&(d=e.button),(d===s.ROTATE&&!r.noRotate||d===s.ZOOM&&!r.noZoom||d===s.PAN&&!r.noPan)&&(m.copy(u(e.pageX,e.pageY)),c.copy(m)),document.addEventListener("mousemove",b,!1),document.addEventListener("mouseup",f,!1),r.dispatchEvent(h))}function b(t){if(!1!==r.enabled){t.preventDefault(),t.stopPropagation(),m.copy(u(t.pageX,t.pageY));var o=m.clone().sub(c);if(c.copy(m),d!==s.ROTATE||r.noRotate)d!==s.ZOOM||r.noZoom?d!==s.PAN||r.noPan||(console.log(o),(Math.abs(o.y)>.01&&Math.abs(o.x)>.01||Math.abs(o.y)<.01)&&(m.y<.5?r.bearingEnd=r.bearing+o.x*r.panSpeed*24:r.bearingEnd=r.bearing-o.x*r.panSpeed*24),(Math.abs(o.y)>.01&&Math.abs(o.x)>.01||Math.abs(o.x)<.01)&&(r.pitchEnd=e.Math.clamp(r.pitch-o.y*r.panSpeed*320,0,r.maxPitch))):r.zoomEnd=e.Math.clamp(r.zoom+o.y*r.zoomSpeed*32,r.minZoom,r.maxZoom);else{var n=E(o);r.coordEnd.x=r.coord.x-n.x,r.coordEnd.y=e.Math.clamp(r.coord.y-n.y,0,i)}}}function f(e){!1!==r.enabled&&(e.preventDefault(),e.stopPropagation(),d=s.NONE,document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",f),r.dispatchEvent(p))}function g(t){if(!1!==r.enabled){switch(t.preventDefault(),t.stopPropagation(),r.dispatchEvent(h),t.deltaMode){case 2:r.zoomEnd=e.Math.clamp(r.zoom+.025*t.deltaY*r.zoomSpeed*32,r.minZoom,r.maxZoom);break;case 1:r.zoomEnd=e.Math.clamp(r.zoom+.01*t.deltaY*r.zoomSpeed*32,r.minZoom,r.maxZoom);break;default:r.zoomEnd=e.Math.clamp(r.zoom+25e-5*t.deltaY*r.zoomSpeed*32,r.minZoom,r.maxZoom)}r.dispatchEvent(p)}}function w(e){!1!==r.enabled&&e.preventDefault()}this.dispose=function(){this.domElement.removeEventListener("contextmenu",w,!1),this.domElement.removeEventListener("mousedown",v,!1),this.domElement.removeEventListener("wheel",g,!1),document.removeEventListener("mousemove",b,!1),document.removeEventListener("mouseup",f,!1)},this.domElement.addEventListener("contextmenu",w,!1),this.domElement.addEventListener("mousedown",v,!1),this.domElement.addEventListener("wheel",g,!1),this.handleResize(),this.update=function(){var t=r.dynamicDampingFactor,o=r.coordEnd.clone().sub(r.coord),n=r.zoomEnd-r.zoom,s=r.bearingEnd-r.bearing,d=r.pitchEnd-r.pitch;if(Math.abs(o.x)>1e-6||Math.abs(o.y)>1e-6||Math.abs(n)>1e-6||Math.abs(s)>1e-6||Math.abs(d)>1e-6?(r.coord.x+=o.x*t,r.coord.y+=o.y*t,r.zoom+=n*t,r.bearing+=s*t,r.pitch+=d*t,r.needsUpdate=!0):(r.coord.copy(r.coordEnd),r.zoom=r.zoomEnd,r.bearing=r.bearingEnd,r.pitch=r.pitchEnd),r.needsUpdate){var c=new e.Spherical(r.mapRadius,r.coord.y,r.coord.x);c.makeSafe();var m=(new e.Vector3).setFromSpherical(c),h=function(t){var o=Math.pow(2,r.zoom-1)*r.mapRadius/1e5,n=(new e.Vector3).setFromSpherical(t);t.phi-=1e-5;var a=(new e.Vector3).setFromSpherical(t).sub(n).normalize();return a.applyAxisAngle(n.clone().normalize(),r.bearing+i),r.pitch>.1?n.normalize().multiplyScalar(Math.tan((90-r.pitch)/180*i)).clone().add(a).normalize().multiplyScalar(o):n.clone().normalize().multiplyScalar(o)}(c);if(r.object.position.copy(m.clone().add(h)),r.pitch>.1){var p=m.clone().normalize().multiplyScalar(h.length()/Math.cos(r.pitch/180*i));r.object.up=p.sub(h).normalize()}else r.object.up=new e.Vector3(Math.cos(a+r.bearing),Math.sin(a+r.bearing),0);r.object.lookAt(m),r.needsUpdate=!1}},this.needsUpdate=!0,this.update()};return t.prototype=Object.create(e.EventDispatcher.prototype),t});
